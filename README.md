# -1

1、通讯

全双工、半双工及单工通讯

根据通讯的数据同步方式，分为同步和异步两种，可以根据通讯过程中是否有使用到时钟信号进行简单的区分。

在同步通讯中，收发设备双方会使用一根信号线表示时钟信号，在时钟信号的驱动下双方进行协
调，同步数据.
通讯中通常双方会统一规定在时钟信号的上升沿或下降沿对数据线进行采样。

在异步通讯中不使用时钟信号进行数据同步，它们直接在数据信号中穿插一些同步用的信号位，
或者把主体数据进行打包，以数据帧的格式传输数据

![image](https://github.com/user-attachments/assets/62eefaba-5c8a-45c1-8090-95b23d14b873)


通讯速率
衡量通讯性能的一个非常重要的参数就是通讯速率，通常以比特率 (Bitrate) 来表示，即每秒钟传
输的二进制位数，单位为比特每秒 (bit/s)

容易与比特率混淆的概念是“波特率”(Baudrate)，它表示每秒钟传输了多少个码元。而码元是通讯信号调制的概念，通讯中常用时间间隔相同的符号
来表示一个二进制数字，这样的信号称为码元

如常见的通讯传输中，用 0V 表示数字 0，5V 表
示数字 1，那么一个码元可以表示两种状态 0 和 1，所以一个码元等于一个二进制比特位，此时
波特率的大小与比特率一致；如果在通讯传输中，有 0V、2V、4V 以及 6V 分别表示二进制数 00、
01、10、11，那么每个码元可以表示四种状态，即两个二进制比特位，所以码元数是二进制比特
位数的一半，这个时候的波特率为比特率的一半

因为很多常见的通讯中一个码元都是表示两种状态，人们常常直接以波特率来表示比特率，虽然严格来说没什么错误，但希望您能了解它们的
区别。

2、

在计算机科学里，大部分复杂的问题都可以通过分层来简化。如芯片被分为内核层和片上外设；STM32HAL 库是在寄存器与用户代码之间的软件层，

对于通讯协议，我们也以分层的方式来理解，最基本的是把它分为物理层和协议层。物理层规定通讯系统中具有机械、电子功能部分的
特性，确保原始数据在物理媒体的传输。协议层主要规定通讯逻辑，统一收发双方的数据打包、解包标准。简单来说物理层规定我们用嘴巴还是用肢体来交流，协议层则规定我们用中文还是英文来交流。

物理层

串口通讯的物理层有很多标准及变种，我们主要讲解 RS-232 标准，RS-232 标准主要规定了信号
的用途、通讯接口以及信号的电平标准。

![image](https://github.com/user-attachments/assets/831cc7eb-ace0-45c2-94cc-bca65f20a65a)

在上面的通讯方式中，两个通讯设备的“DB9 接口”之间通过串口信号线建立起连接，串口信号
线中使用“RS-232 标准”传输数据信号。由于 RS-232 电平标准的信号不能直接被控制器直接识
别，所以这些信号会经过一个“电平转换芯片”转换成控制器能识别的“TTL 标准”的电平信号，
才能实现通讯。

电平标准

根据通讯使用的电平标准不同，串口通讯可分为 TTL 标准及 RS-232 标准

![image](https://github.com/user-attachments/assets/a5771caa-49e4-4dd6-a43c-a881933c3482)

我们知道常见的电子电路中常使用 TTL 的电平标准，理想状态下，使用 5V 表示二进制逻辑 1，
使用 0V 表示逻辑 0；而为了增加串口通讯的远距离传输及抗干扰能力，它使用-15V 表示逻辑 1，
+15V 表示逻辑 0


RS-232 信号线

  在最初的应用中，RS-232 串口标准常用于计算机、路由与调制调解器 (MODEN，俗称“猫”) 之
  间的通讯，在这种通讯系统中，设备被分为数据终端设备 DTE(计算机、路由) 和数据通讯设备
  DCE(调制调解器)。

在目前的其它工业控制使用的串口通讯中，一般只使用 RXD、TXD 以及 GND 三条信号线，直
接传输数据信号

协议层

串口通讯的数据包由发送设备通过自身的 TXD 接口传输到接收设备的 RXD 接口。在串口通讯
的协议层中，规定了数据包的内容，它由启始位、主体数据、校验位以及停止位组成，通讯双方
的数据包格式要约定一致才能正常收发数据

![image](https://github.com/user-attachments/assets/a773655e-f134-403f-85a5-c7489ed47245)

波特率

串口异步通讯，异步通讯中由于没有时钟信号 (如前面讲解的 DB9 接口中是没有时钟信号的)，所以两个通讯设备之间需要约定好波特率，即每个码元的长度，以便对信
号进行解码

  通讯的起始和停止信号
      串口通讯的一个数据包从起始信号开始，直到停止信号结束。数据包的起始信号由一个逻辑 0 的
      数据位表示，而数据包的停止信号可由 0.5、1、1.5 或 2 个逻辑 1 的数据位表示，只要双方约定
      一致即可。
	  
  有效数据
      在数据包的起始位之后紧接着的就是要传输的主体数据内容，也称为有效数据，有效数据的长度
      常被约定为 5、6、7 或 8 位长
	  
  数据校验
  	  在有效数据之后，有一个可选的数据校验位。由于数据通信相对更容易受到外部干扰导致传输
	  数据出现偏差，可以在传输过程加上校验位来解决这个问题。校验方法有奇校验 (odd)、偶校验
	 (even)、0 校验 (space)、1 校验 (mark) 以及无校验 (noparity)
  
  	奇校验要求有效数据和校验位中“1”的个数为奇数，比如一个 8 位长的有效数据为：01101001，
  	此时总共有 4 个“1”，为达到奇校验效果，校验位为“1”，最后传输的数据将是 8 位的有效数据
  	加上 1 位的校验位总共 9 位。

 	偶校验与奇校验要求刚好相反，要求帧数据和校验位中“1”的个数为偶数，比如数据帧：11001010，
 	此时数据帧“1”的个数为 4 个，所以偶校验位为“0”。
 
	 0 校验是不管有效数据中的内容是什么，校验位总为“0”，1 校验是校验位总为“1”。

USART 简介

有别于 USART 还有一个 UART(UniversalAsynchronous Receiver and Transmitter)，它是在 USART 基础上裁剪掉了同步通信功能，只有异步
通信。简单区分同步和异步就是看通信时需不需要对外提供时钟输出，我们平时用的串口通信基
本都是 UART。

串行通信一般是以帧格式传输数据，即是一帧一帧的传输，每帧包含有起始信号、数据信息、停
止信息，可能还有校验信息。USART 就是对这些传输参数有具体规定，当然也不是只有唯一一
个参数值，很多参数值都可以自定义设置，只是增强它的兼容性

USART 在 STM32 应用最多莫过于“打印”程序信息，一般在硬件设计时都会预留一个 USART
通信接口连接电脑，用于在调试程序是可以把一些调试信息“打印”在电脑端的串口调试助手工
具上，从而了解程序运行是否正确、如果出错哪具体哪里出错等等。

USART 的功能框图包含了 USART 最核心内容，掌握了功能框图，对 USART 就有一个整体的把
握，在编程时就思路就非常清晰

![image](https://github.com/user-attachments/assets/6da7ecbb-3f1e-44be-8b5e-0f7188ae0ef7)

TX：发送数据输出引脚。
RX：接收数据输入引脚。
SW_RX：数据接收引脚，只用于单线和智能卡模式，属于内部引脚，没有具体外部引脚。
nRTS：请求以发送 (Request To Send)，n 表示低电平有效。如果使能 RTS 流控制，当 USART 接
收器准备好接收新数据时就会将 nRTS 变成低电平；当接收寄存器已满时，nRTS 将被设置为高
电平。该引脚只适用于硬件流控制。
nCTS：清除以发送 (Clear To Send)，n 表示低电平有效。如果使能 CTS 流控制，发送器在发送下
一帧数据之前会检测 nCTS 引脚，如果为低电平，表示可以发送数据，如果为高电平则在发送完
当前数据帧之后停止发送。该引脚只适用于硬件流控制。
SCLK：发送器时钟输出引脚。这个引脚仅适用于同步模式

![image](https://github.com/user-attachments/assets/bde3cf84-e614-420e-95c4-73a1d40a369a)


STM32F103VET6 系统控制器有三个 USART 和两个 UART，其中 USART1 和时钟来源于 APB2 总
线时钟，其最大频率为 72MHz，其他四个的时钟来源于 APB1 总线时钟，其最大频率为 36MHz。
UART 只是异步传输功能，所以没有 SCLK、nCTS 和 nRTS 功能引脚。

数据寄存器

USART 数据寄存器 (USART_DR) 只有低 9 位有效，并且第 9 位数据是否有效要取决于 USART
控制寄存器 1(USART_CR1) 的 M 位设置，当 M 位为 0 时表示 8 位数据字长，当 M 位为 1 表示 9
位数据字长，我们一般使用 8 位数据字长。

USART_DR 包含了已发送的数据或者接收到的数据。USART_DR 实际是包含了两个寄存器，一
个专门用于发送的可写 TDR，一个专门用于接收的可读 RDR。当进行发送操作时，往 USART_DR
写入数据会自动存储在 TDR 内；当进行读取操作时，向 USART_DR 读取数据会自动提取 RDR
数据。

TDR 和 RDR 都是介于系统总线和移位寄存器之间。串行通信是一个位一个位传输的，发送时把
TDR 内容转移到发送移位寄存器，然后把移位寄存器数据每一位发送出去，接收时把接收到的
每一位顺序保存在接收移位寄存器内然后才转移到 RDR。

USART 支持 DMA 传输，可以实现高速数据传输

控制器
USART 有专门控制发送的发送器、控制接收的接收器，还有唤醒单元、中断控制等等

使用USART 之前需要向 USART_CR1 寄存器的 UE 位置 1 使能 USART，UE 位用来开启供给给串口
的时钟。发送或者接收数据字长可选 8 位或 9 位，由 USART_CR1 的 M 位控制

	发送器
 
	当 USART_CR1 寄存器的发送使能位 TE 置 1 时，启动数据发送，发送移位寄存器的数据会在 TX
	引脚输出，低位在前，高位在后。如果是同步模式 SCLK 也输出时钟信号

	一个字符帧发送需要三个部分：起始位 + 数据帧 + 停止位。起始位是一个位周期的低电平，位周
	期就是每一位占用的时间；数据帧就是我们要发送的 8 位或 9 位数据，数据是从最低位开始传输
	的；停止位是一定时间周期的高电平

	停止位时间长短是可以通过 USART 控制寄存器 2(USART_CR2) 的 STOP[1:0] 位控制，可选 0.5
	个、1 个、1.5 个和 2 个停止位。默认使用 1 个停止位。2 个停止位适用于正常 USART 模式、单
	线模式和调制解调器模式。0.5 个和 1.5 个停止位用于智能卡模式。

	当选择 8 位字长，使用 1 个停止位时，具体发送字符时序图


	![image](https://github.com/user-attachments/assets/ce640a20-aa46-4599-a3cc-c308df97758f)


  中断控制


	![image](https://github.com/user-attachments/assets/7d9aa923-e939-4fa3-95bf-2d021ddea589)
 
USART 只需两根信号线即可完成双向通信，对硬件要求低，使得很多模块都预留 USART 接口来
实现与其他模块或者控制器进行数据传输，比如 GSM 模块，WIFI 模块、蓝牙模块等等。在硬件
设计时，注意还需要一根“共地线”。

硬件设计

为利用 USART 实现开发板与电脑通信，需要用到一个 USB 转 USART 的 IC，我们选择 CH340G
芯片来实现这个功能，CH340G 是一个 USB 总线的转接芯片，实现 USB 转 USART、USB 转 lrDA
红外或者 USB 转打印机接口，我们使用其 USB 转 USART 功能

我们将 CH340G 的 TXD 引脚与 USART1 的 RX 引脚连接，CH340G 的 RXD 引脚与 USART1 的
TX 引脚连接。CH340G 芯片集成在开发板上，其地线 (GND) 已与控制器的 GND 连通。

USB 转串口硬件设计

![image](https://github.com/user-attachments/assets/a3d7fe43-56fa-4df1-af25-354989d0ccd3)


非阻塞发送是一种通信方式，指的是在发送数据时，程序不需要等待数据全部发送完成，而是能立即返回继续执行其他任务。这种方式特别适用于实时性要求较高或需要并发处理的系统。

阻塞发送的特点
调用发送函数后，程序会一直停留在这个函数中，直到数据全部发送完成。
在此期间，CPU无法做其他工作。
简单易用，但效率低下，尤其是在需要发送大量数据或多任务处理的系统中。


串口中断函数
HAL_UART_Receive_IT
解析
1. 函数简介
HAL_UART_Receive_IT 是 STM32 HAL 库中实现的一种 非阻塞接收函数，通过中断模式接收指定数量的数据。

2. 函数功能
函数用于启动 UART 的数据接收过程，同时不会阻塞 CPU。
接收过程依赖 UART 的接收中断（RXNE 中断）来逐字节处理数据，直到完成所有接收任务。
当数据接收完成或发生错误时，相关回调函数（如 HAL_UART_RxCpltCallback）会被触发。
3. 参数说明
huart: 指向 UART_HandleTypeDef 类型的结构体，包含了 UART 的硬件配置和状态信息。
pData: 指向接收数据存储缓冲区的指针。
Size: 指定要接收的数据量（以字节或 16 位单位为数据单元）。


unsigned char data[5];

HAL_UART_Receive_IT(&huart1,data,5);

接收5个数据后，触发接收中断

要实现连续接收数据后触发中断，仅需在中断函数中
再次调用HAL_UART_Receive_IT即可。

void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)
{
	
    HAL_GPIO_TogglePin(LED1_GPIO_Port,LED1_Pin);
	  HAL_UART_Receive_IT(&huart1,data,5);
}


实现判断接收数据为1时，使led翻转
void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)
{
	if(data =='1'){
		HAL_GPIO_TogglePin(LED1_GPIO_Port,LED1_Pin);
	}
    
	  HAL_UART_Receive_IT(&huart1,&data,1);
}


DMA—直接存储区访问

直接存储器存取(DMA)用来提供在外设和存储器之间或者存储器和存储器之间的高速数据传
输。无须CPU干预，数据可以通过DMA快速地移动，这就节省了CPU的资源来做其他操作。
两个DMA控制器有12个通道(DMA1有7个通道，DMA2有5个通道)，每个通道专门用来管理来自
于一个或多个外设对存储器访问的请求。还有一个仲裁器来协调各个DMA请求的优先权。

DMA主要特性

每个通道都直接连接专用的硬件DMA请求，每个通道都同样支持软件触发。这些功能通过
软件来配置

在同一个DMA模块上，多个请求间的优先权可以通过软件编程设置(共有四级：很高、高、
中等和低)，优先权设置相等时由硬件决定(请求0优先于请求1，依此类推) 。

闪存、SRAM、外设的SRAM、APB1、APB2和AHB外设均可作为访问的源和目标

![image](https://github.com/user-attachments/assets/f4927959-1479-4a2f-9f23-54e7a08efba3)

在发生一个事件后，外设向DMA控制器发送一个请求信号。DMA控制器根据通道的优先权处理
请求。当DMA控制器开始访问发出请求的外设时，DMA控制器立即发送给它一个应答信号。当
从DMA控制器得到应答信号时，外设立即释放它的请求。一旦外设释放了这个请求，DMA控制
器同时撤销应答信号

总之，每次DMA传送由3个操作组成：

	从外设数据寄存器或者从当前外设/存储器地址寄存器指示的存储器地址取数据，第一次传
	输时的开始地址是DMA_CPARx或DMA_CMARx寄存器指定的外设基地址或存储器单元

	存数据到外设数据寄存器或者当前外设/存储器地址寄存器指示的存储器地址，第一次传输
	时的开始地址是DMA_CPARx或DMA_CMARx寄存器指定的外设基地址或存储器单元

	执行一次DMA_CNDTRx寄存器的递减操作，该寄存器包含未完成的操作数目。

仲裁器

仲裁器根据通道请求的优先级来启动外设/存储器的访问。

优先权管理分2个阶段：

● 软件：每个通道的优先权可以在DMA_CCRx寄存器中设置，有4个等级：
─ 最高优先级
─ 高优先级
─ 中等优先级
─ 低优先级

● 硬件：如果2个请求有相同的软件优先级，则较低编号的通道比较高编号的通道有较高的优
先权。举个例子，通道2优先于通道4。


DMA 通道

每个通道都可以在有固定地址的外设寄存器和存储器地址之间执行DMA传输。DMA传输的数据
量是可编程的，最大达到65535。包含要传输的数据项数量的寄存器，在每次传输后递减


通道配置过程

下面是配置DMA通道x的过程(x代表通道号)：

	1. 在DMA_CPARx寄存器中设置外设寄存器的地址。发生外设数据传输请求时，这个地址将
	是数据传输的源或目标

	2. 在DMA_CMARx寄存器中设置数据存储器的地址。发生外设数据传输请求时，传输的数
	据将从这个地址读出或写入这个地址

	3. 在DMA_CNDTRx寄存器中设置要传输的数据量。在每个数据传输后，这个数值递减

	4. 在DMA_CCRx寄存器的PL[1:0]位中设置通道的优先级

	5. 在DMA_CCRx寄存器中设置数据传输的方向、循环模式、外设和存储器的增量模式、外
	设和存储器的数据宽度、传输一半产生中断或传输完成产生中断。
	
	6. 设置DMA_CCRx寄存器的ENABLE位，启动该通道。
 在DMA_CCRx寄存器中设置数据传输的方向、循环模式、外设和存储器的增量模式、外设和存储器的数据宽度、传输一半产生中断或传输完成产生中断。设置DMA_CCRx寄存器的ENABLE位，启动该通道。

循环模式

循环模式用于处理循环缓冲区和连续的数据传输(如ADC的扫描模式)。在DMA_CCRx寄存器中
的CIRC位用于开启这一功能。当启动了循环模式，数据传输的数目变为0时，将会自动地被恢
复成配置通道时设置的初值，DMA操作将会继续进行

存储器到存储器模式

DMA通道的操作可以在没有外设请求的情况下进行，这种操作就是存储器到存储器模式。
当设置了DMA_CCRx寄存器中的MEM2MEM位之后，在软件设置了DMA_CCRx寄存器中的EN
位启动DMA通道时，DMA传输将马上开始。当DMA_CNDTRx寄存器变为0时，DMA传输结
束。存储器到存储器模式不能与循环模式同时使用。

中断

每个DMA通道都可以在DMA传输过半、传输完成和传输错误时产生中断。为应用的灵活性考
虑，通过设置寄存器的不同位来打开这些中断。

![image](https://github.com/user-attachments/assets/f0b653aa-0f78-40c9-8e5e-cb2321eb8dfb)


DMA请求映像

DMA1控制器

从外设(TIMx[x=1、2、3、4]、ADC1、SPI1、SPI/I2S2、I2Cx[x=1、2]和USARTx[x=1、2、3])
产生的7个请求，通过逻辑或输入到DMA1控制器，这意味着同时只能有一个请求有效。参见下
图的DMA1请求映像。

外设的DMA请求，可以通过设置相应外设寄存器中的控制位，被独立地开启或关闭


![image](https://github.com/user-attachments/assets/95ad9f86-2456-4514-801d-7dd1e9d4f004)


DMA控制器(DMA)


![image](https://github.com/user-attachments/assets/0f886f4b-d0aa-4931-b76f-bee30da1f03b)

DMA寄存器










































