# -1

1、通讯

全双工、半双工及单工通讯

根据通讯的数据同步方式，分为同步和异步两种，可以根据通讯过程中是否有使用到时钟信号进行简单的区分。

在同步通讯中，收发设备双方会使用一根信号线表示时钟信号，在时钟信号的驱动下双方进行协
调，同步数据.
通讯中通常双方会统一规定在时钟信号的上升沿或下降沿对数据线进行采样。

在异步通讯中不使用时钟信号进行数据同步，它们直接在数据信号中穿插一些同步用的信号位，
或者把主体数据进行打包，以数据帧的格式传输数据

![image](https://github.com/user-attachments/assets/62eefaba-5c8a-45c1-8090-95b23d14b873)


通讯速率
衡量通讯性能的一个非常重要的参数就是通讯速率，通常以比特率 (Bitrate) 来表示，即每秒钟传
输的二进制位数，单位为比特每秒 (bit/s)

容易与比特率混淆的概念是“波特率”(Baudrate)，它表示每秒钟传输了多少个码元。而码元是通讯信号调制的概念，通讯中常用时间间隔相同的符号
来表示一个二进制数字，这样的信号称为码元

如常见的通讯传输中，用 0V 表示数字 0，5V 表
示数字 1，那么一个码元可以表示两种状态 0 和 1，所以一个码元等于一个二进制比特位，此时
波特率的大小与比特率一致；如果在通讯传输中，有 0V、2V、4V 以及 6V 分别表示二进制数 00、
01、10、11，那么每个码元可以表示四种状态，即两个二进制比特位，所以码元数是二进制比特
位数的一半，这个时候的波特率为比特率的一半

因为很多常见的通讯中一个码元都是表示两种状态，人们常常直接以波特率来表示比特率，虽然严格来说没什么错误，但希望您能了解它们的
区别。

2、

在计算机科学里，大部分复杂的问题都可以通过分层来简化。如芯片被分为内核层和片上外设；STM32HAL 库是在寄存器与用户代码之间的软件层，

对于通讯协议，我们也以分层的方式来理解，最基本的是把它分为物理层和协议层。物理层规定通讯系统中具有机械、电子功能部分的
特性，确保原始数据在物理媒体的传输。协议层主要规定通讯逻辑，统一收发双方的数据打包、解包标准。简单来说物理层规定我们用嘴巴还是用肢体来交流，协议层则规定我们用中文还是英文来交流。

物理层

串口通讯的物理层有很多标准及变种，我们主要讲解 RS-232 标准，RS-232 标准主要规定了信号
的用途、通讯接口以及信号的电平标准。

![image](https://github.com/user-attachments/assets/831cc7eb-ace0-45c2-94cc-bca65f20a65a)

在上面的通讯方式中，两个通讯设备的“DB9 接口”之间通过串口信号线建立起连接，串口信号
线中使用“RS-232 标准”传输数据信号。由于 RS-232 电平标准的信号不能直接被控制器直接识
别，所以这些信号会经过一个“电平转换芯片”转换成控制器能识别的“TTL 标准”的电平信号，
才能实现通讯。

电平标准

根据通讯使用的电平标准不同，串口通讯可分为 TTL 标准及 RS-232 标准

![image](https://github.com/user-attachments/assets/a5771caa-49e4-4dd6-a43c-a881933c3482)

我们知道常见的电子电路中常使用 TTL 的电平标准，理想状态下，使用 5V 表示二进制逻辑 1，
使用 0V 表示逻辑 0；而为了增加串口通讯的远距离传输及抗干扰能力，它使用-15V 表示逻辑 1，
+15V 表示逻辑 0


RS-232 信号线

  在最初的应用中，RS-232 串口标准常用于计算机、路由与调制调解器 (MODEN，俗称“猫”) 之
  间的通讯，在这种通讯系统中，设备被分为数据终端设备 DTE(计算机、路由) 和数据通讯设备
  DCE(调制调解器)。

在目前的其它工业控制使用的串口通讯中，一般只使用 RXD、TXD 以及 GND 三条信号线，直
接传输数据信号

协议层

串口通讯的数据包由发送设备通过自身的 TXD 接口传输到接收设备的 RXD 接口。在串口通讯
的协议层中，规定了数据包的内容，它由启始位、主体数据、校验位以及停止位组成，通讯双方
的数据包格式要约定一致才能正常收发数据

![image](https://github.com/user-attachments/assets/a773655e-f134-403f-85a5-c7489ed47245)

波特率

串口异步通讯，异步通讯中由于没有时钟信号 (如前面讲解的 DB9 接口中是没有时钟信号的)，所以两个通讯设备之间需要约定好波特率，即每个码元的长度，以便对信
号进行解码

  通讯的起始和停止信号
      串口通讯的一个数据包从起始信号开始，直到停止信号结束。数据包的起始信号由一个逻辑 0 的
      数据位表示，而数据包的停止信号可由 0.5、1、1.5 或 2 个逻辑 1 的数据位表示，只要双方约定
      一致即可。
	  
  有效数据
      在数据包的起始位之后紧接着的就是要传输的主体数据内容，也称为有效数据，有效数据的长度
      常被约定为 5、6、7 或 8 位长
	  
  数据校验
  	  在有效数据之后，有一个可选的数据校验位。由于数据通信相对更容易受到外部干扰导致传输
	  数据出现偏差，可以在传输过程加上校验位来解决这个问题。校验方法有奇校验 (odd)、偶校验
	 (even)、0 校验 (space)、1 校验 (mark) 以及无校验 (noparity)
  
  	奇校验要求有效数据和校验位中“1”的个数为奇数，比如一个 8 位长的有效数据为：01101001，
  	此时总共有 4 个“1”，为达到奇校验效果，校验位为“1”，最后传输的数据将是 8 位的有效数据
  	加上 1 位的校验位总共 9 位。

 	偶校验与奇校验要求刚好相反，要求帧数据和校验位中“1”的个数为偶数，比如数据帧：11001010，
 	此时数据帧“1”的个数为 4 个，所以偶校验位为“0”。
 
	 0 校验是不管有效数据中的内容是什么，校验位总为“0”，1 校验是校验位总为“1”。

USART 简介

有别于 USART 还有一个 UART(UniversalAsynchronous Receiver and Transmitter)，它是在 USART 基础上裁剪掉了同步通信功能，只有异步
通信。简单区分同步和异步就是看通信时需不需要对外提供时钟输出，我们平时用的串口通信基
本都是 UART。

串行通信一般是以帧格式传输数据，即是一帧一帧的传输，每帧包含有起始信号、数据信息、停
止信息，可能还有校验信息。USART 就是对这些传输参数有具体规定，当然也不是只有唯一一
个参数值，很多参数值都可以自定义设置，只是增强它的兼容性

USART 在 STM32 应用最多莫过于“打印”程序信息，一般在硬件设计时都会预留一个 USART
通信接口连接电脑，用于在调试程序是可以把一些调试信息“打印”在电脑端的串口调试助手工
具上，从而了解程序运行是否正确、如果出错哪具体哪里出错等等。

USART 的功能框图包含了 USART 最核心内容，掌握了功能框图，对 USART 就有一个整体的把
握，在编程时就思路就非常清晰

![image](https://github.com/user-attachments/assets/6da7ecbb-3f1e-44be-8b5e-0f7188ae0ef7)

TX：发送数据输出引脚。
RX：接收数据输入引脚。
SW_RX：数据接收引脚，只用于单线和智能卡模式，属于内部引脚，没有具体外部引脚。
nRTS：请求以发送 (Request To Send)，n 表示低电平有效。如果使能 RTS 流控制，当 USART 接
收器准备好接收新数据时就会将 nRTS 变成低电平；当接收寄存器已满时，nRTS 将被设置为高
电平。该引脚只适用于硬件流控制。
nCTS：清除以发送 (Clear To Send)，n 表示低电平有效。如果使能 CTS 流控制，发送器在发送下
一帧数据之前会检测 nCTS 引脚，如果为低电平，表示可以发送数据，如果为高电平则在发送完
当前数据帧之后停止发送。该引脚只适用于硬件流控制。
SCLK：发送器时钟输出引脚。这个引脚仅适用于同步模式

![image](https://github.com/user-attachments/assets/bde3cf84-e614-420e-95c4-73a1d40a369a)


STM32F103VET6 系统控制器有三个 USART 和两个 UART，其中 USART1 和时钟来源于 APB2 总
线时钟，其最大频率为 72MHz，其他四个的时钟来源于 APB1 总线时钟，其最大频率为 36MHz。
UART 只是异步传输功能，所以没有 SCLK、nCTS 和 nRTS 功能引脚。

数据寄存器

USART 数据寄存器 (USART_DR) 只有低 9 位有效，并且第 9 位数据是否有效要取决于 USART
控制寄存器 1(USART_CR1) 的 M 位设置，当 M 位为 0 时表示 8 位数据字长，当 M 位为 1 表示 9
位数据字长，我们一般使用 8 位数据字长。

USART_DR 包含了已发送的数据或者接收到的数据。USART_DR 实际是包含了两个寄存器，一
个专门用于发送的可写 TDR，一个专门用于接收的可读 RDR。当进行发送操作时，往 USART_DR
写入数据会自动存储在 TDR 内；当进行读取操作时，向 USART_DR 读取数据会自动提取 RDR
数据。

TDR 和 RDR 都是介于系统总线和移位寄存器之间。串行通信是一个位一个位传输的，发送时把
TDR 内容转移到发送移位寄存器，然后把移位寄存器数据每一位发送出去，接收时把接收到的
每一位顺序保存在接收移位寄存器内然后才转移到 RDR。

USART 支持 DMA 传输，可以实现高速数据传输

控制器
USART 有专门控制发送的发送器、控制接收的接收器，还有唤醒单元、中断控制等等

使用USART 之前需要向 USART_CR1 寄存器的 UE 位置 1 使能 USART，UE 位用来开启供给给串口
的时钟。发送或者接收数据字长可选 8 位或 9 位，由 USART_CR1 的 M 位控制

	发送器
 
	当 USART_CR1 寄存器的发送使能位 TE 置 1 时，启动数据发送，发送移位寄存器的数据会在 TX
	引脚输出，低位在前，高位在后。如果是同步模式 SCLK 也输出时钟信号

	一个字符帧发送需要三个部分：起始位 + 数据帧 + 停止位。起始位是一个位周期的低电平，位周
	期就是每一位占用的时间；数据帧就是我们要发送的 8 位或 9 位数据，数据是从最低位开始传输
	的；停止位是一定时间周期的高电平

	停止位时间长短是可以通过 USART 控制寄存器 2(USART_CR2) 的 STOP[1:0] 位控制，可选 0.5
	个、1 个、1.5 个和 2 个停止位。默认使用 1 个停止位。2 个停止位适用于正常 USART 模式、单
	线模式和调制解调器模式。0.5 个和 1.5 个停止位用于智能卡模式。

	当选择 8 位字长，使用 1 个停止位时，具体发送字符时序图


	![image](https://github.com/user-attachments/assets/ce640a20-aa46-4599-a3cc-c308df97758f)


  中断控制


	![image](https://github.com/user-attachments/assets/7d9aa923-e939-4fa3-95bf-2d021ddea589)
 
USART 只需两根信号线即可完成双向通信，对硬件要求低，使得很多模块都预留 USART 接口来
实现与其他模块或者控制器进行数据传输，比如 GSM 模块，WIFI 模块、蓝牙模块等等。在硬件
设计时，注意还需要一根“共地线”。

硬件设计

为利用 USART 实现开发板与电脑通信，需要用到一个 USB 转 USART 的 IC，我们选择 CH340G
芯片来实现这个功能，CH340G 是一个 USB 总线的转接芯片，实现 USB 转 USART、USB 转 lrDA
红外或者 USB 转打印机接口，我们使用其 USB 转 USART 功能

我们将 CH340G 的 TXD 引脚与 USART1 的 RX 引脚连接，CH340G 的 RXD 引脚与 USART1 的
TX 引脚连接。CH340G 芯片集成在开发板上，其地线 (GND) 已与控制器的 GND 连通。

USB 转串口硬件设计

![image](https://github.com/user-attachments/assets/a3d7fe43-56fa-4df1-af25-354989d0ccd3)


非阻塞发送是一种通信方式，指的是在发送数据时，程序不需要等待数据全部发送完成，而是能立即返回继续执行其他任务。这种方式特别适用于实时性要求较高或需要并发处理的系统。

阻塞发送的特点
调用发送函数后，程序会一直停留在这个函数中，直到数据全部发送完成。
在此期间，CPU无法做其他工作。
简单易用，但效率低下，尤其是在需要发送大量数据或多任务处理的系统中。


串口中断函数
HAL_UART_Receive_IT
解析
1. 函数简介
HAL_UART_Receive_IT 是 STM32 HAL 库中实现的一种 非阻塞接收函数，通过中断模式接收指定数量的数据。

2. 函数功能
函数用于启动 UART 的数据接收过程，同时不会阻塞 CPU。
接收过程依赖 UART 的接收中断（RXNE 中断）来逐字节处理数据，直到完成所有接收任务。
当数据接收完成或发生错误时，相关回调函数（如 HAL_UART_RxCpltCallback）会被触发。
3. 参数说明
huart: 指向 UART_HandleTypeDef 类型的结构体，包含了 UART 的硬件配置和状态信息。
pData: 指向接收数据存储缓冲区的指针。
Size: 指定要接收的数据量（以字节或 16 位单位为数据单元）。


unsigned char data[5];

HAL_UART_Receive_IT(&huart1,data,5);

接收5个数据后，触发接收中断

要实现连续接收数据后触发中断，仅需在中断函数中
再次调用HAL_UART_Receive_IT即可。

void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)
{
	
    HAL_GPIO_TogglePin(LED1_GPIO_Port,LED1_Pin);
	  HAL_UART_Receive_IT(&huart1,data,5);
}


实现判断接收数据为1时，使led翻转
void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)
{
	if(data =='1'){
		HAL_GPIO_TogglePin(LED1_GPIO_Port,LED1_Pin);
	}
    
	  HAL_UART_Receive_IT(&huart1,&data,1);
}

参考网址

https://www.bilibili.com/video/BV1Qb421H7dL/?spm_id_from=333.337.search-card.all.click&vd_source=f78fe3c9e663e6bb9e1c73a434781f38

DMA—直接存储区访问

直接存储器存取(DMA)用来提供在外设和存储器之间或者存储器和存储器之间的高速数据传
输。无须CPU干预，数据可以通过DMA快速地移动，这就节省了CPU的资源来做其他操作。
两个DMA控制器有12个通道(DMA1有7个通道，DMA2有5个通道)，每个通道专门用来管理来自
于一个或多个外设对存储器访问的请求。还有一个仲裁器来协调各个DMA请求的优先权。

DMA主要特性

每个通道都直接连接专用的硬件DMA请求，每个通道都同样支持软件触发。这些功能通过
软件来配置

在同一个DMA模块上，多个请求间的优先权可以通过软件编程设置(共有四级：很高、高、
中等和低)，优先权设置相等时由硬件决定(请求0优先于请求1，依此类推) 。

闪存、SRAM、外设的SRAM、APB1、APB2和AHB外设均可作为访问的源和目标

![image](https://github.com/user-attachments/assets/f4927959-1479-4a2f-9f23-54e7a08efba3)

在发生一个事件后，外设向DMA控制器发送一个请求信号。DMA控制器根据通道的优先权处理
请求。当DMA控制器开始访问发出请求的外设时，DMA控制器立即发送给它一个应答信号。当
从DMA控制器得到应答信号时，外设立即释放它的请求。一旦外设释放了这个请求，DMA控制
器同时撤销应答信号

总之，每次DMA传送由3个操作组成：

	从外设数据寄存器或者从当前外设/存储器地址寄存器指示的存储器地址取数据，第一次传
	输时的开始地址是DMA_CPARx或DMA_CMARx寄存器指定的外设基地址或存储器单元

	存数据到外设数据寄存器或者当前外设/存储器地址寄存器指示的存储器地址，第一次传输
	时的开始地址是DMA_CPARx或DMA_CMARx寄存器指定的外设基地址或存储器单元

	执行一次DMA_CNDTRx寄存器的递减操作，该寄存器包含未完成的操作数目。

仲裁器

仲裁器根据通道请求的优先级来启动外设/存储器的访问。

优先权管理分2个阶段：

● 软件：每个通道的优先权可以在DMA_CCRx寄存器中设置，有4个等级：
─ 最高优先级
─ 高优先级
─ 中等优先级
─ 低优先级

● 硬件：如果2个请求有相同的软件优先级，则较低编号的通道比较高编号的通道有较高的优
先权。举个例子，通道2优先于通道4。


DMA 通道

每个通道都可以在有固定地址的外设寄存器和存储器地址之间执行DMA传输。DMA传输的数据
量是可编程的，最大达到65535。包含要传输的数据项数量的寄存器，在每次传输后递减


通道配置过程

下面是配置DMA通道x的过程(x代表通道号)：

	1. 在DMA_CPARx寄存器中设置外设寄存器的地址。发生外设数据传输请求时，这个地址将
	是数据传输的源或目标

	2. 在DMA_CMARx寄存器中设置数据存储器的地址。发生外设数据传输请求时，传输的数
	据将从这个地址读出或写入这个地址

	3. 在DMA_CNDTRx寄存器中设置要传输的数据量。在每个数据传输后，这个数值递减

	4. 在DMA_CCRx寄存器的PL[1:0]位中设置通道的优先级

	5. 在DMA_CCRx寄存器中设置数据传输的方向、循环模式、外设和存储器的增量模式、外
	设和存储器的数据宽度、传输一半产生中断或传输完成产生中断。
	
	6. 设置DMA_CCRx寄存器的ENABLE位，启动该通道。
 在DMA_CCRx寄存器中设置数据传输的方向、循环模式、外设和存储器的增量模式、外设和存储器的数据宽度、传输一半产生中断或传输完成产生中断。设置DMA_CCRx寄存器的ENABLE位，启动该通道。

循环模式

循环模式用于处理循环缓冲区和连续的数据传输(如ADC的扫描模式)。在DMA_CCRx寄存器中
的CIRC位用于开启这一功能。当启动了循环模式，数据传输的数目变为0时，将会自动地被恢
复成配置通道时设置的初值，DMA操作将会继续进行

存储器到存储器模式

DMA通道的操作可以在没有外设请求的情况下进行，这种操作就是存储器到存储器模式。
当设置了DMA_CCRx寄存器中的MEM2MEM位之后，在软件设置了DMA_CCRx寄存器中的EN
位启动DMA通道时，DMA传输将马上开始。当DMA_CNDTRx寄存器变为0时，DMA传输结
束。存储器到存储器模式不能与循环模式同时使用。

中断

每个DMA通道都可以在DMA传输过半、传输完成和传输错误时产生中断。为应用的灵活性考
虑，通过设置寄存器的不同位来打开这些中断。

![image](https://github.com/user-attachments/assets/f0b653aa-0f78-40c9-8e5e-cb2321eb8dfb)


DMA请求映像

DMA1控制器

从外设(TIMx[x=1、2、3、4]、ADC1、SPI1、SPI/I2S2、I2Cx[x=1、2]和USARTx[x=1、2、3])
产生的7个请求，通过逻辑或输入到DMA1控制器，这意味着同时只能有一个请求有效。参见下
图的DMA1请求映像。

外设的DMA请求，可以通过设置相应外设寄存器中的控制位，被独立地开启或关闭


![image](https://github.com/user-attachments/assets/95ad9f86-2456-4514-801d-7dd1e9d4f004)


DMA控制器(DMA)


![image](https://github.com/user-attachments/assets/0f886f4b-d0aa-4931-b76f-bee30da1f03b)

DMA寄存器

DMA中断状态寄存器(DMA_ISR)

DMA中断标志清除寄存器(DMA_IFCR)

DMA通道x配置寄存器(DMA_CCRx)(x = 1…7) 

DMA通道x传输数量寄存器(DMA_CNDTRx)(x = 1…7) 

DMA通道x外设地址寄存器(DMA_CPARx)(x = 1…7)

DMA通道x存储器地址寄存器(DMA_CMARx)(x = 1…7) 

以上是中文参考手册内容

以下是野火内容

DMA(Direct Memory Access)—直接存储器存取，是单片机的一个外设，它的主要功能是用来搬数
据，但是不需要占用 CPU，即在传输数据的时候，CPU 可以干其他的事情，好像是多线程一样。
数据传输支持从外设到存储器或者存储器到存储器，这里的存储器可以是 SRAM 或者是 FLASH。
DMA 控制器包含了 DMA1 和 DMA2，其中 DMA1 有 7 个通道，DMA2 有 5 个通道，这里的通道
可以理解为传输数据的一种管道。要注意的是 DMA2 只存在于大容量的单片机中。

DMA 请求
如果外设要想通过 DMA 来传输数据，必须先给 DMA 控制器发送 DMA 请求，DMA 收到请求信
号之后，控制器会给外设一个应答信号，当外设应答后且 DMA 控制器收到应答信号之后，就会
启动 DMA 的传输，直到传输完毕。
DMA 有 DMA1 和 DMA2 两个控制器，DMA1 有 7 个通道，DMA2 有 5 个通道，不同的 DMA 控
制器的通道对应着不同的外设请求，这决定了我们在软件编程上该怎么设置，具体见 DMA 请求映像表。


![image](https://github.com/user-attachments/assets/6ea01eda-c6ac-4b39-b1bb-524d40b63cce)


通道
DMA 具有 12 个独立可编程的通道，其中 DMA1 有 7 个通道，DMA2 有 5 个通道，每个通道对
应不同的外设的 DMA 请求。虽然每个通道可以接收多个外设的请求，但是同一时间只能接收一
个，不能同时接收多个

仲裁器
当发生多个 DMA 通道请求时，就意味着有先后响应处理的顺序问题，这个就由仲裁器也管理。
仲裁器管理 DMA 通道请求分为两个阶段。第一阶段属于软件阶段，可以在 DMA_CCRx 寄存器
中设置，有 4 个等级：非常高、高、中和低四个优先级。第二阶段属于硬件阶段，如果两个或以
上的 DMA 通道请求设置的优先级一样，则他们优先级取决于通道编号，编号越低优先权越高，
比如通道 0 高于通道 1。在大容量产品和互联型产品中，DMA1 控制器拥有高于 DMA2 控制器的
优先级。

DMA 数据配置
使用 DMA，最核心就是配置要传输的数据，包括数据从哪里来，要到哪里去，传输的数据的单
位是什么，要传多少数据，是一次传输还是循环传输等等。

从哪里来到哪里去
我们知道 DMA 传输数据的方向有三个：从外设到存储器，从存储器到外设，从存储器到存储器。
具体的方向 DMA_CCR 位 4 DIR 配置：0 表示从外设到存储器，1 表示从存储器到外设。这里面
涉及到的外设地址由 DMA_CPAR 配置，存储器地址由 DMA_CMAR 配置。

外设到存储器
当我们使用从外设到存储器传输时，以 ADC 采集为例。DMA 外设寄存器的地址对应的就是 ADC
数据寄存器的地址，DMA 存储器的地址就是我们自定义的变量（用来接收存储 AD 采集的数据）
的地址。方向我们设置外设为源地址。

存储器到外设
当我们使用从存储器到外设传输时，以串口向电脑端发送数据为例。DMA 外设寄存器的地址对
应的就是串口数据寄存器的地址，DMA 存储器的地址就是我们自定义的变量（相当于一个缓冲
区，用来存储通过串口发送到电脑的数据）的地址。方向我们设置外设为目标地址

存储器到存储器
当我们使用从存储器到存储器传输时，以内部 FLASH 向内部 SRAM 复制数据为例。DMA 外设寄
存器的地址对应的就是内部 FLASH（我们这里把内部 FALSH 当作一个外设来看）的地址，DMA
存储器的地址就是我们自定义的变量（相当于一个缓冲区，用来存储来自内部 FLASH 的数据）
的地址。方向我们设置外设（即内部 FLASH）为源地址。跟上面两个不一样的是，这里需要把
DMA_CCR 位 14：MEM2MEM：存储器到存储器模式配置为 1，启动 M2M 模式。

要传多少，单位是什么

当我们配置好数据要从哪里来到哪里去之后，我们还需要知道我们要传输的数据是多少，数据的
单位是什么。

以串口向电脑发送数据为例，我们可以一次性给电脑发送很多数据，具体多少由 DMA_CNDTR
配置，这是一个 32 位的寄存器，一次最多只能传输 65535 个数据。

要想数据传输正确，源和目标地址存储的数据宽度还必须一致，串口数据寄存器是 8 位的，所以
我们定义的要发送的数据也必须是 8 位。外设的数据宽度由 DMA_CCR 的 PSIZE[1:0] 配置，可
以是 8/16/32 位，存储器的数据宽度由 DMA_CCR 的 MSIZE[1:0] 配置，可以是 8/16/32 位。

在 DMA 控制器的控制下，数据要想有条不紊的从一个地方搬到另外一个地方，还必须正确设置
两边数据指针的增量模式。外设的地址指针由 DMA_CCRx 的 PINC 配置，存储器的地址指针由
MINC 配置。以串口向电脑发送数据为例，要发送的数据很多，每发送完一个，那么存储器的地
址指针就应该加 1，而串口数据寄存器只有一个，那么外设的地址指针就固定不变。具体的数据
指针的增量模式由实际情况决定。

什么时候传输完成

数据什么时候传输完成，我们可以通过查询标志位或者通过中断的方式来鉴别。每个 DMA 通道
在 DMA 传输过半、传输完成和传输错误时都会有相应的标志位，如果使能了该类型的中断后，
则会产生中断。有关各个标志位的详细描述请参考 DMA 中断状态寄存器 DMA_ISR 的详细描述。

传输完成还分两种模式，是一次传输还是循环传输，一次传输很好理解，即是传输一次之后就停
止，要想再传输的话，必须关断 DMA 使能后再重新配置后才能继续传输。循环传输则是一次传
输完成之后又恢复第一次传输时的配置循环传输，不断的重复。具体的由 DMA_CCR 寄存器的
CIRC 循环模式位控制


DMA 初始化结构体详解
HAL 库函数对每个外设都建立了一个初始化结构体 xxx_InitTypeDef(xxx 为外设名称)，结构体成
员用于设置外设工作参数，并由 HAL 库函数 xxx_Init() 调用这些设定参数进入设置外设相应的
寄存器，达到配置外设工作环境的目的。

DMA_InitTypeDef 初始化结构体

typedef struct {
uint32_t Direction; //传输方向
uint32_t PeriphInc; //外设递增
uint32_t MemInc; //存储器递增
uint32_t PeriphDataAlignment; //外设数据宽度
uint32_t MemDataAlignment; //存储器数据宽度
uint32_t Mode; //模式选择
uint32_t Priority; //优先级
} DMA_InitTypeDef;

1) Direction：传输方向选择，可选外设到存储器、存储器到外设以及存储器到存储器。它设定
DMA_SxCR 寄存器的 DIR[1:0] 位的值。ADC 采集显然使用外设到存储器模式。

2) PeripheralInc：如果配置为 DMA_PINC_ENABLE，使能外设地址自动递增功能，它设定
DMA_CCR 寄存器的 PINC 位的值；一般外设都是只有一个数据寄存器，所以一般不会使能该
位。

3) MemoryInc：如果配置为 DMA_MINC_ENABLE，使能存储器地址自动递增功能，它设定
DMA_CCR 寄存器的 MINC 位的值；我们自定义的存储区一般都是存放多个数据的，所以要使能
存储器地址自动递增功能。

4) PeriphDataAlignment：外设数据宽度，可选字节 (8 位)、半字 (16 位) 和字 (32 位)，它设定
DMA_SxCR 寄存器的 PSIZE[1:0] 位的值。ADC 数据寄存器只有低 16 位数据有效，使用半字
数据宽度。

5) Mode：DMA 传输模式选择，可选一次传输或者循环传输，它设定 DMA_SxCR 寄存器的 CIRC
位的值。我们希望 ADC 采集是持续循环进行的，所以使用循环传输模式

6) 软件设置数据流的优先级，有 4 个可选优先级分别为非常高、高、中和低，它设定 DMA_SxCR
寄存器的 PL[1:0] 位的值。DMA 优先级只有在多个 DMA 数据流同时使用时才有意义，这里我们
设置为非常高优先级就可以了。


存储器种类

存储器是用来存储程序代码和数据的部件，有了存储器计
算机才具有记忆功能


![image](https://github.com/user-attachments/assets/930da153-8a78-42a0-b27d-b35eaecac705)

存储器按其存储介质特性主要分为“易失性存储器”和“非易失性存储器”两大类。其中的“易
失/非易失”是指存储器断电后，它存储的数据内容是否会丢失的特性。

由于一般易失性存储器存取速度快，而非易失性存储器可长期保存数据，它们都在计算机中占据着重要角色。在计算机
中易失性存储器最典型的代表是内存，非易失性存储器的代表则是硬盘


RAM 存储器

RAM 是“Random Access Memory”的缩写，被译为随机存储器。所谓“随机存取”，指的是当存
储器中的消息被读取或写入时，所需要的时间与这段信息所在的位置无关。这个词的由来是因为
早期计算机曾使用磁鼓作为存储器，磁鼓是顺序读写设备，而 RAM 可随读取其内部任意地址的
数据，时间都是相同的，因此得名。实际上现在 RAM 已经专门用于指代作为计算机内存的易失
性半导体存储器。

根据 RAM 的存储机制，又分为动态随机存储器 DRAM(Dynamic RAM) 以及静态随机存储器
SRAM(Static RAM) 两种。

DRAM
动态随机存储器 DRAM 的存储单元以电容的电荷来表示数据，有电荷代表 1，无电荷代表 0，见
图 22_2。但时间一长，代表 1 的电容会放电，代表 0 的电容会吸收电荷，因此它需要定期刷新操
作，这就是“动态 (Dynamic)”一词所形容的特性。刷新操作会对电容进行检查，若电量大于满
电量的 1/2，则认为其代表 1，并把电容充满电；若电量小于 1/2，则认为其代表 0，并把电容放
电，藉此来保证数据的正确性。


	![image](https://github.com/user-attachments/assets/a0a6f473-b36d-4fb1-b76f-bb982c615cbc)


	SDRAM
	根据 DRAM 的通讯方式，又分为同步和异步两种，这两种方式根据通讯时是否需要使用时钟信
	号来区分。图 22_3 是一种利用时钟进行同步的通讯时序，它在时钟的上升沿表示有效数据。
	
	
	![image](https://github.com/user-attachments/assets/40428202-b9ad-4df5-98c1-cb6b7624a1f4)
	
	由于使用时钟同步的通讯速度更快，所以同步 DRAM 使用更为广泛，这种 DRAM 被称为
	SDRAM(Synchronous DRAM)
	
	DDR SDRAM
	为了进一步提高 SDRAM 的通讯速度，人们设计了 DDR SDRAM 存储器 (Double Data Rate
	SDRAM)。它的存储特性与 SDRAM 没有区别，但 SDRAM 只在上升沿表示有效数据，在 1 个
	时钟周期内，只能表示 1 个有数据；而 DDR SDRAM 在时钟的上升沿及下降沿各表示一个数据，
	也就是说在 1 个时钟周期内可以表示 2 位数据，在时钟频率同样的情况下，提高了一倍的速度。
	至于 DDRII 和 DDRIII，它们的通讯方式并没有区别，主要是通讯同步时钟的频率提高了。
	当前个人计算机常用的内存条是 DDRIII SDRAM 存储器，在一个内存条上包含多个 DDRIII
	SDRAM 芯片。

SRAM
静态随机存储器 SRAM 的存储单元以锁存器来存储数据，见图 22_4。这种电路结构不需要定时
刷新充电，就能保持状态 (当然，如果断电了，数据还是会丢失的)，所以这种存储器被称为“静
态 (Static)”RAM。部分批次 SRAM 芯片替换为 AS6C8016 型号时序与 ISSI 的芯片兼容

非易失性存储器
非易失性存储器种类非常多，半导体类的有 ROM 和 FLASH，而其它的则包括光盘、软盘及机械
硬盘。

ROM 存储器
ROM 是“Read Only Memory”的缩写，意为只能读的存储器。由于技术的发展，后来设计出了可
以方便写入数据的 ROM，而这个“Read Only Memory”的名称被沿用下来了，现在一般用于指代
非易失性半导体存储器，包括后面介绍的 FLASH 存储器，有些人也把它归到 ROM 类里边

MASK ROM
MASK(掩膜) ROM 就是正宗的“Read Only Memory”，存储在它内部的数据是在出厂时使用特殊
工艺固化的，生产后就不可修改，其主要优势是大批量生产时成本低。当前在生产量大，数据不
需要修改的场合，还有应用。

OTPROM
OTPROM(One Time Programable ROM) 是一次可编程存储器。这种存储器出厂时内部并没有资料，
用户可以使用专用的编程器将自己的资料写入，但只能写入一次，被写入过后，它的内容也不可
再修改。在 NXP 公司生产的控制器芯片中常使用 OTPROM 来存储密钥；在 STM32F429 芯片中
也具有一部分 OTPROM 空间

EPROM
EPROM(Erasable Programmable ROM) 是可重复擦写的存储器，它解决了 PROM 芯片只能写入一
次的问题。这种存储器使用紫外线照射芯片内部擦除数据，擦除和写入都要专用的设备。现在这
种存储器基本淘汰，被 EEPROM 取代。

EEPROM
EEPROM(Electrically Erasable Programmable ROM) 是电可擦除存储器。EEPROM 可以重复擦写，它
的擦除和写入都是直接使用电路控制，不需要再使用外部设备来擦写。而且可以按字节为单位修
改数据，无需整个芯片擦除。现在主要使用的 ROM 芯片都是 EEPROM。


FLASH 存储器
FLASH 存储器又称为闪存，它也是可重复擦写的储器，部分书籍会把 FLASH 存储器称为 FLASH
ROM，但它的容量一般比 EEPROM 大得多，且在擦除时，一般以多个字节为单位。如有的 FLASH
存储器以 4096 个字节为扇区，最小的擦除单位为一个扇区。根据存储单元电路的不同，FLASH
存储器又分为 NOR FLASH 和 NAND FLASH

由于 NOR 的地址线和数据线分开，它可以按“字节”读写数据，符合 CPU 的指令译码执行要求，
所以假如 NOR 上存储了代码指令，CPU 给 NOR 一个地址，NOR 就能向 CPU 返回一个数据让

而由于 NAND 的数据和地址线共用，只能按“块”来读写数据，假如 NAND 上存储了代码指令，
CPU 给 NAND 地址后，它无法直接返回该地址的数据，所以不符合指令译码要求。表 22‑2 中的
最后一项“是否支持 XIP”描述的就是这种立即执行的特性 (eXecute In Place)。
若代码存储在 NAND 上，可以把它先加载到 RAM 存储器上，再由 CPU 执行。所以在功能上可
以认为 NOR 是一种断电后数据不丢失的 RAM，但它的擦除单位与 RAM 有区别，且读写速度比
RAM 要慢得多。

另外，FLASH 的擦除次数都是有限的 (现在普遍是 10 万次左右)，当它的使用接近寿命的时候，
可能会出现写操作失败。由于 NAND 通常是整块擦写，块内有一位失效整个块就会失效，这被
称为坏块，而且由于擦写过程复杂，从整体来说 NOR 块块更少，寿命更长。由于可能存在坏块，
所以 FLASH 存储器需要“探测/错误更正 (EDC/ECC)”算法来确保数据的正确性。
由于两种 FLASH 存储器特性的差异，NOR FLASH 一般应用在代码存储的场合，如嵌入式控制器
内部的程序存储空间。而 NAND FLASH 一般应用在大数据量存储的场合，包括 SD 卡、U 盘以
及固态硬盘等，都是 NAND FLASH 类型的。

在本教程中会对如何使用 RAM、EEPROM、FLASH 存储器进行实例讲解

下面是 I2C 总线的一些特征

• 只要求两条总线线路 一条串行数据线 SDA 一条串行时钟线 SCL
• 每个连接到总线的器件都可以通过唯一的地址和一直存在的简单的主机 从机关系软件设定地址 主机可以作为主机发送器或主机接收器
• 它是一个真正的多主机总线 如果两个或更多主机同时初始化数据传输可以通过冲突检测和仲裁防止数据被破坏
• 串行的 8 位双向数据传输位速率在标准模式下可达 100kbit/s 快速模式下可达 400kbit/s 高速模式下可达 3.4Mbit/s
• 片上的滤波器可以滤去总线数据线上的毛刺波 保证数据完整
• 连接到相同总线的 IC 数量只受到总线的最大电容 400pF 限制

总体特征

SDA 和 SCL 都是双向线路都通过一个电流源或上拉电阻连接到正的电源电压 见图 3 当总线空
闲时 这两条线路都是高电平 连接到总线的器件输出级必须是漏极开路或集电极开路才能执行线与的功
能

由于连接到 I2C 总线的器件有不同种类的工艺 CMOS NMOS 双极性 逻辑 0 低 和 1
高 的电平不是固定的 它由 VDD 的相关电平决定 见第 15 章的电气规范 每传输一个数据位就产生
一个时钟脉冲

数据的有效性
SDA 线上的数据必须在时钟的高电平周期保持稳定 数据线的高或低电平状态只有在 SCL 线的时钟
信号是低电平时才能改变


![image](https://github.com/user-attachments/assets/a0c85a48-f04f-4615-a6d8-b4dd8f344875)

![image](https://github.com/user-attachments/assets/48c4b085-b3f0-48e9-8d04-c51ebe8ca205)

只有低电平时，数据线才能变化，高电平时只能维持原状态。

起始和停止条件

在 I2C 总线中 唯一出现的是被定义为起始 S 和停止 P 条件

起始条件：其中一种情况是在 SCL 线是高电平时 SDA 线从高电平向低电平切换。

停止条件：当 SCL 是高电平时 SDA 线由低电平向高电平切换表示。


起始和停止条件一般由主机产生 总线在起始条件后被认为处于忙的状态 在停止条件的某段时间后
总线被认为再次处于空闲状态

如果产生重复起始 Sr 条件而不产生停止条件 总线会一直处于忙的状态 此时的起始条件 S
和重复起始 Sr 条件在功能上是一样的

如果连接到总线的器件合并了必要的接口硬件 那么用它们检测起始和停止条件十分简便 但是 没
有这种接口的微控制器在每个时钟周期至少要采样 SDA 线两次来判别有没有发生电平切换

![image](https://github.com/user-attachments/assets/56652e85-3ab3-49ba-b88c-f90c4988fd6e)


传输数据
	字节格式
	发送到 SDA 线上的每个字节必须为 8 位 每次传输可以发送的字节数量不受限制 每个字节后必须跟
	一个响应位 首先传输的是数据的最高位 MSB ，

	如果从机要完成一些其他功能后 例如一个
	内部中断服务程序 才能接收或发送下一个完整的数据字节 可以使时钟线 SCL 保持低电平迫使主机进入
	等待状态 当从机准备好接收下一个数据字节并释放时钟线 SCL 后 数据传输继续
响应
数据传输必须带响应 相关的响应时钟脉冲由主机产生 在响应的时钟脉冲期间 发送器释放 SDA 线 (高)

在响应的时钟脉冲期间 接收器必须将 SDA 线拉低 使它在这个时钟脉冲的高电平期间保持稳定的低
电平，当然 必须考虑建立和保持时间

当从机不能响应从机地址时 例如它正在执行一些实时函数不能接收或发送 从机必须使数据线保持
高电平 主机然后产生一个停止条件终止传输或者产生重复起始条件开始新的传输

如果从机 接收器响应了从机地址但是在传输了一段时间后不能接收更多数据字节 主机必须再一次
终止传输 这个情况用从机在第一个字节后没有产生响应来表示 从机使数据线保持高电平 主机产生一
个停止或重复起始条件

如果传输中有主机接收器 它必须通过在从机不产生时钟的最后一个字节不产生一个响应 向从机
发送器通知数据结束 从机 发送器必须释放数据线 允许主机产生一个停止或重复起始条







三极管

NPN PNP

三个极分别是发射极e （Emitter）、基极b (Base)和集电极c (Collector)

![image](https://github.com/user-attachments/assets/b9da0560-7e7f-4b12-8a52-20bfde31f0ab)

从下往上都是ebc

两者除了电源极性不同外，其工作原理都是相同的，电流放大

导通电压看bc之间的二极管走向，npn是Ubc>0,pnp则相反

工作状态有三种

截至状态 放大状态 饱和状态

放大状态

当加在三极管发射结的电压大于PN结的导通电压，并处于某一恰当的值时，三极管的发射结正向偏置，集电结反向偏置，这时基极电流对集电极电流起着控制作用，使三极管具有电流放大作用，
其电流放大倍数β=ΔIc/ΔIb，这时三极管处放大状态


ADC中文参考手册：描述的模块适用于整个STM32F10xxx微控制器系列

12位ADC是一种逐次逼近型模拟数字转换器，逐次逼近的意思是，ADC内部存在两个器件，分别是DAC和逐次逼近寄存器（SAR）

各通道的A/D转换可以单次、连续、扫描或间断模式执行，ADC的结果可以左对齐或右对齐方式存储在16位数据寄存器中

模拟看门狗特性允许应用程序检测输入电压是否超出用户定义的高/低阀值

ADC的输入时钟不得超过14MHz，它是由PCLK2经分频产生

12位分辨率

转换结束、注入转换结束和发生模拟看门狗事件时产生中断

单次和连续转换模式

从通道0到通道n的自动扫描模式

自校准   带内嵌数据一致性的数据对齐  采样间隔可以按通道分别编程

● 规则转换和注入转换均有外部触发选项

● 间断模式

● 双重模式(带2个或以上ADC的器件) 

● ADC转换时间

ADC转换时间
STM32F103xx增强型产品：时钟为56MHz时为1μs(时钟为72MHz为1.17μs) 
─ STM32F101xx基本型产品：时钟为28MHz时为1μs(时钟为36MHz为1.55μs) 
─ STM32F102xxUSB型产品：时钟为48MHz时为1.2μs 
─ STM32F105xx和STM32F107xx产品：时钟为56MHz时为1μs(时钟为72MHz为1.17μs) 

ADC供电要求：2.4V到3.6V

ADC输入范围：VREF- ≤ VIN ≤ VREF+

ADC的输入框图
VREF+和VREF-是ADC的的参考电压的来源，一般用来接3.3v和0v，VDDA和VSSA

		ADC中的VREF+、VREF-和VDDA、VSSA有什么区别和联系
		
		VREF+ 和 VREF- 是 ADC 的参考电压输入，定义了 ADC 的输入电压范围
		
			这是 ADC 的高参考电压，决定输入信号的最大可测量电压。
			
			通常连接到系统中一个稳定的高精度参考电压源。
			
			对应于 ADC 数字输出的最大值，例如，对于 12 位 ADC，输入信号为 𝑉𝑅𝐸𝐹+时，数字输出为 2的12次方-1 = 4095
			
			VREF-（参考电压负端）
			
			这是 ADC 的低参考电压，定义输入信号的最小可测量电压。
			
			通常连接到地（GND）或另一个低电压参考源。
			
			对应于 ADC 数字输出的最小值（通常为 0）
		
		VDDA 和 VSSA 是 ADC 模拟电路的电源和地
		
			VDDA（模拟电源）
			
			供给 ADC 模拟部分的电源电压。
			通常是与系统电源一致的电压，例如 3.3V或 5.0V，必须保持稳定和低噪声，以保证 ADC 的精度。
			
			VSSA（模拟地）
			ADC 模拟部分的地信号。
			通常与系统地（GND）连接，但在设计中，可能会通过单独的模拟地平面减少数字噪声干扰。
		
		![image](https://github.com/user-attachments/assets/ff96d949-ba4e-4bdf-ae53-4074cc7d85cd)
		
		注意
		
			参考电压的选择
			
				高精度的 ADC 通常需要稳定的参考电压源，避免噪声或波动影响测量精度。
				
				VREF+ 不一定等于 VDDA，可以使用独立的参考电压芯片提高系统性能。
			
			电源和地的隔离
			
				VDDA/VSSA 和数字部分电源/地应尽量隔离，例如采用独立电源平面或滤波电路，减少数字信号对 ADC 的干扰。
			
				VDDA/VSSA 和数字部分电源/地应尽量隔离，什么是数字部分电源/地
			
			噪声抑制
			
				高精度 ADC 需要对 
				
				VDDA、VREF+ 进行适当的滤波和去耦，避免系统噪声对 ADC 转换精度的影响。
		
		什么是数字部分电源/地？
		
		数字部分电源（VDD 或 VDDIO）：
		
		供给芯片内部数字电路的电源。包括处理器内核、寄存器、定时器、逻辑电路等。通常是为数字信号逻辑（0/1）切换提供能量。
		
		数字部分地（VSS）：
		
		供数字电路使用的参考地。通常与系统的总地（GND）连接，用作数字信号的电压基准。
		
		![image](https://github.com/user-attachments/assets/5cea3467-51f2-43f7-811f-fee7234399df)
		
		为什么需要隔离？
		
		数字部分的逻辑电路工作时，会产生大量的高频开关噪声（由于数字信号在0和1之间快速切换）。这些噪声会通过公共电源和地传导，影响到模拟部分的工作，导致 ADC 或 DAC 的信号失真或精度下降。
		
		具体表现为：
		
		电源噪声：数字电路切换时会产生瞬态电流变化，导致电源电压波动。这种波动可能传递到模拟部分的供电，干扰 ADC 的精确测量。
		
		地电位差：数字部分和模拟部分的地电流不同，可能引起地电位偏移，进一步影响模拟电路的参考地。
		
		隔离的常见设计方法
		
			独立供电：
			
			使用独立的电源为模拟部分和数字部分供电。比如，数字部分用 3.3V，模拟部分用高精度的低噪声3.3V 电源。
			
			分离电源平面：
			
			在 PCB 设计中，模拟电源（VDDA）和数字电源（VDD）使用独立的供电平面，避免电流交叉干扰。
			
			地的分离与连接：
			
			模拟地（VSSA）和数字地（VSS）通常在 PCB 中分开布线，只在一个点（如芯片的 GND 引脚或星形接地点）连接，避免地回路干扰。
			
			滤波与去耦：
			
			在 VDDA 和 VSSA 之间加高质量的去耦电容（如 10μF 和 100nF并联）。
			
			使用滤波电路（如电感或电阻+电容组合）隔离数字电源噪声。
			
			电磁屏蔽：
			
			在设计中通过屏蔽壳或屏蔽层减少数字信号对模拟部分的电磁干扰。
		
		总结
		
			数字部分电源/地（VDD/VSS）： 为逻辑电路和数字模块供电，信号频繁切换，可能引入高频噪声。
			
			模拟部分电源/地（VDDA/VSSA）： 为 ADC、DAC 等模拟模块供电，要求低噪声、高稳定性。
			
			隔离的核心目标： 减少数字部分噪声对模拟部分的干扰，提高 ADC/DAC 等模拟模块的精度和稳定性。

ADC开关控制

设置ADC_CR2寄存器的ADON位可给ADC上电，

ADC上电延迟一段时间后(tSTAB)，再次设置ADON位时开始进行转换

通过清除ADON位可以停止转换，并将ADC置于断电模式。在这个模式中，ADC几乎不耗电(仅几个μA)。

ADC时钟

由时钟控制器提供的ADCCLK时钟和PCLK2(APB2时钟)同步。RCC控制器为ADC时钟提供一个专用的可编程预分频器

通道选择

有16个多路通道。可以把转换组织成两组：规则组和注入组。在任意多个通道上以任意顺序进行的一系列转换构成成组转换。例如，可以如下顺序完成转换：通道3、通道8、通道2、通道2、通道0、通道2、通道2、通道15。

规则组由多达16个转换组成。规则通道和它们的转换顺序在ADC_SQRx寄存器中选择。规
则组中转换的总数应写入ADC_SQR1寄存器的L[3:0]位中。

● 注入组由多达4个转换组成。注入通道和它们的转换顺序在ADC_JSQR寄存器中选择。注入
组里的转换总数目应写入ADC_JSQR寄存器的L[1:0]位中

ADC通道的规则通道和注入通道是什么

规则通道（Regular Channel）和注入通道（Injected Channel）是两种不同的采样和转换模式，提供灵活的信号采集方式。

规则通道（Regular Channel）

	特点
 
		优先级： 转换优先级低于注入通道。
  
		工作方式：
			用于常规的周期性采样或大部分普通的ADC采样任务。
   
			转换操作可以被注入通道打断，等待注入通道完成后继续。
   
			触发： 支持软件触发或硬件触发（如定时器触发）。
   
			转换顺序： 支持多通道转换，按定义的规则队列顺序逐个采样。
		用途
  
			常用于定期采样的场景，例如：
   
				测量传感器信号（温度、压力）。
	   
				常规电压采集（如电池电压）。
注入通道（Injected Channel）

	特点
 
	优先级： 转换优先级高于规则通道。
 
	工作方式：
 
		用于处理实时性要求较高的采样任务。
		当注入通道触发时，会中断规则通道的转换，优先完成注入通道的采样。
  
	触发： 通常由外部事件或硬件触发（如GPIO中断）来启动，支持特定情况下的软件触发。
	转换顺序： 支持多通道注入，按注入队列的顺序采样。

	用途
	
		常用于优先级较高的实时采样，例如：过流或过压保护时的紧急电压采样。动态监测需要优先处理的信号（如电机控制中的电流采样）。

  ![image](https://github.com/user-attachments/assets/304fd7cd-05e2-410f-832d-daba08f2b796)

STM32配置中的实际说明

规则通道配置

	配置多个规则通道，指定每个通道的采样顺序和采样时间。

触发源可设置为：

	软件启动。
 
	硬件触发（如定时器输出比较事件）。

注入通道配置

指定触发源，例如外部中断或特定硬件事件。

配置注入通道队列的顺序和采样时间。

![image](https://github.com/user-attachments/assets/c687b5cd-5925-4ce8-a6de-6741c3885f94)

单次转换模式

	单次转换模式下，ADC只执行一次转换。该模式既可通过设置ADC_CR2寄存器的ADON位(只适用于规则通道)启动也可通过外部触发启动(适用于规则通道或注入通道)，这时CONT位为0。

如果一个规则通道被转换：

	─ 转换数据被储存在16位ADC_DR寄存器中
	
	─ EOC(转换结束)标志被设置
	
	─ 如果设置了EOCIE，则产生中断

 如果一个注入通道被转换：
 
	─ 转换数据被储存在16位的ADC_DRJ1寄存器中
	
	─ JEOC(注入转换结束)标志被设置
	
	─ 如果设置了JEOCIE位，则产生中断。
 
然后ADC停止

连续转换模式

	在连续转换模式中，当前面ADC转换一结束马上就启动另一次转换。此模式可通过外部触发启动或通过设置ADC_CR2寄存器上的ADON位启动，此时CONT位是1。

 每个转换后：
 
	● 如果一个规则通道被转换：
 
		─ 转换数据被储存在16位的ADC_DR寄存器中
  
		─ EOC(转换结束)标志被设置
  
		─ 如果设置了EOCIE，则产生中断。
  
  ● 如果一个注入通道被转换：
  
		─ 转换数据被储存在16位的ADC_DRJ1寄存器中
 	
		─ JEOC(注入转换结束)标志被设置
 
		─ 如果设置了JEOCIE位，则产生中断

时序图

![image](https://github.com/user-attachments/assets/0e528375-b249-41ca-8150-d86d0a38dc92)

ADC在开始精确转换前需要一个稳定时间tSTAB。在开始ADC转换和14个时钟周期后，EOC标志被设置，16位ADC数据寄存器包含转换的结果。

从图中能看出，第一次ACON置位，是唤醒ADC，给其上电，第二次置位，则开始让ADC工作。(这个图可能有点问题)

模拟看门狗

如果被ADC转换的模拟电压低于低阀值或高于高阀值，AWD模拟看门狗状态位被设置

阀值位于ADC_HTR和ADC_LTR寄存器的最低12个有效位中。通过设置ADC_CR1寄存器的AWDIE位以允许产生相应中断

阀值独立于由ADC_CR2寄存器上的ALIGN位选择的数据对齐模式。比较是在对齐之前完成的

通过配置ADC_CR1寄存器，模拟看门狗可以作用于1个或多个通道


![image](https://github.com/user-attachments/assets/1a135874-d013-41dc-8287-ed265e1321ed)

扫描模式

此模式用来扫描一组模拟通道。

扫描模式可通过设置ADC_CR1寄存器的SCAN位来选择。一旦这个位被设置，ADC扫描所有被ADC_SQRX寄存器(对规则通道)或ADC_JSQR(对注入通道)选中的所有通道。

在每个组的每个通道上执行单次转换。在每个转换结束时，同一组的下一个通道被自动转换。

如果设置了CONT位，转换不会在选择组的最后一个通道上停止，而是再次从选择组的第一个通道继续转换。

如果设置了DMA位，在每次EOC(转换完成)后，DMA控制器把规则组通道的转换数据传输到SRAM中。而注入通道转换的数据总是存储在ADC_JDRx寄存器中。

注入通道管理

触发注入

清除ADC_CR1寄存器的JAUTO位，并且设置SCAN位，即可使用触发注入功能

	利用外部触发或通过设置ADC_CR2寄存器的ADON位，启动一组规则通道的转换。
	
	如果在规则通道转换期间产生一外部注入触发，当前转换被复位，注入通道序列被以单次
	扫描方式进行转换。
	
	然后，恢复上次被中断的规则组通道转换。如果在注入转换期间产生一规则事件，注入转
	换不会被中断，但是规则序列将在注入序列结束后被执行。

 以下为简单的 ADC 初始化和启动代码片段

	 // 假设已配置 ADC 的相关寄存器和通道
	// 启动 ADC 单次转换
	
	// 1. 启用 ADC，第一次设置 ADON
	ADC1->CR2 |= ADC_CR2_ADON; // 上电并唤醒 ADC
	HAL_Delay(tSTAB);          // 等待 tSTAB 上电稳定时间
	
	// 2. 启动转换，第二次设置 ADON
	ADC1->CR2 |= ADC_CR2_ADON; // 启动规则通道单次转换
	
	// 3. 等待转换完成
	while (!(ADC1->SR & ADC_SR_EOC)) {}
	
	// 4. 获取转换结果
	uint16_t result = ADC1->DR;
	
	// 5. 停止 ADC
	ADC1->CR2 &= ~ADC_CR2_ADON; // 清除 ADON 位，关闭 ADC



![image](https://github.com/user-attachments/assets/ef714353-f2db-4c8e-a297-119fd739fca4)

间断模式

	规则组
	
		此模式通过设置ADC_CR1寄存器上的DISCEN位激活。
		
		它可以用来执行一个短序列的n次转换(n<=8)，此转换是ADC_SQRx(序列寄存器:可以用来配置通道的个数和要使用哪个通道)寄存器所选择的转换序列的一部分
		
		数值n由ADC_CR1寄存器的DISCNUM[2:0]位给出
		
		一个外部触发信号可以启动ADC_SQRx寄存器中描述的下一轮n次转换，直到此序列所有的转
		换完成为止。总的序列长度由ADC_SQR1寄存器的L[3:0]定
		
		举例：
		
		n=3，被转换的通道 = 0、1、2、3、6、7、9、10 
		
		第一次触发：转换的序列为 0、1、2 
		
		第二次触发：转换的序列为 3、6、7 
		
		第三次触发：转换的序列为 9、10，并产生EOC事件
		
		第四次触发：转换的序列 0、1、2
		
		当以间断模式转换一个规则组时，转换序列结束后不自动从头开始。
		当所有子组被转换完成，下一次触发启动第一个子组的转换。在上面的例子中，第四次触发重
		新转换第一子组的通道 0、1和2。

	注入组
		此模式通过设置ADC_CR1寄存器的JDISCEN位激活。在一个外部触发事件后，该模式按通道顺序逐个转换ADC_JSQR寄存器中选择的序列。

		  一个外部触发信号可以启动ADC_JSQR寄存器选择的下一个通道序列的转换，直到序列中所有
		的转换完成为止。总的序列长度由ADC_JSQR寄存器的JL[1:0]位定义。

		例子：
  
		n=1，被转换的通道 = 1、2、3 
  
		第一次触发：通道1被转换
  
		第二次触发：通道2被转换
  
		第三次触发：通道3被转换，并且产生EOC和JEOC事件
  
		第四次触发：通道1被转换

	1 当完成所有注入通道转换，下个触发启动第1个注入通道的转换。在上述例子中，第四个
	触发重新转换第1个注入通道1。
 
	2 不能同时使用自动注入和间断模式
 
	3 必须避免同时为规则和注入组设置间断模式。间断模式只能作用于一组转换。


校准

	ADC有一个内置自校准模式。校准可大幅减小因内部电容器组的变化而造成的准精度误差。在
	校准期间，在每个电容器上都会计算出一个误差修正码(数字值)，这个码用于消除在随后的转换
	中每个电容器上产生的误差。
	
	通过设置ADC_CR2寄存器的CAL位启动校准。一旦校准结束，CAL位被硬件复位，可以开始正
	常转换
	
	建议在上电时执行一次ADC校准。校准阶段结束后，校准码储存在ADC_DR中。

1 建议在每次上电后执行一次校准。

2 启动校准前，ADC必须处于关电状态(ADON=’0’)超过至少两个ADC时钟周期。


 ![image](https://github.com/user-attachments/assets/216bd600-039a-4b8e-8a66-0d9aeb83f6b9)

数据对齐

ADC_CR2寄存器中的ALIGN位选择转换后数据储存的对齐方式。

数据可以左对齐或右对齐，


![image](https://github.com/user-attachments/assets/7f698019-3db6-4127-b834-10530333c327)


![image](https://github.com/user-attachments/assets/36bfe2f3-ea52-43d4-af66-ad43de34fa06)

可编程的通道采样时间

ADC使用若干个ADC_CLK周期对输入电压采样，采样周期数目可以通过ADC_SMPR1和
ADC_SMPR2寄存器中的SMP[2:0]位更改

每个通道可以分别用不同的时间采样。


![image](https://github.com/user-attachments/assets/2fe1c30e-4fb4-4742-8d82-64032321b3fb)


![image](https://github.com/user-attachments/assets/a4a2eb34-d5bd-4277-b135-12fec3a780e6)

外部触发转换

转换可以由外部事件触发(例如定时器捕获，EXTI线)

如果设置了EXTTRIG控制位，则外部事件就能够触发转换。EXTSEL[2:0]和JEXTSEL2:0]控制位允许应用程序选择8个可能的事件中的
某一个，可以触发规则和注入组的采样

当外部触发信号被选为ADC规则或注入转换时，只有它的上升沿可以启动转换。


![image](https://github.com/user-attachments/assets/a798c012-7867-43cb-8093-866b355e0ddb)


![image](https://github.com/user-attachments/assets/cdf7eedd-363d-4555-97d5-cdfc744197d0)


![image](https://github.com/user-attachments/assets/5b9e5aa1-1d36-4996-a774-6c2a336828da)


![image](https://github.com/user-attachments/assets/4afd890f-261a-44c8-a498-d413c00f7703)

DMA请求

	因为规则通道转换的值储存在一个仅有的数据寄存器中，所以当转换多个规则通道时需要使用
	DMA，这可以避免丢失已经存储在ADC_DR寄存器中的数据。
	
	只有在规则通道的转换结束时才产生DMA请求，并将转换的数据从ADC_DR寄存器传输到用户
	指定的目的地址
	
	只有ADC1和ADC3拥有DMA功能。由ADC2转化的数据可以通过双ADC模式，利用ADC1的
	DMA功能传输。

双ADC模式

在有2个或以上ADC模块的产品中，可以使用双ADC模式

在双ADC模式里，根据ADC1_CR1寄存器中DUALMOD[2:0]位所选的模式，转换的启动可以是
ADC1主和ADC2从的交替触发或同步触发

在双ADC模式里，当转换配置成由外部事件触发时，用户必须将其设置成仅触发主ADC，从
ADC设置成软件触发，这样可以防止意外的触发从转换。但是，主和从ADC的外部触发必须同
时被激活

共有6种可能的模式：

─ 同步注入模式

─ 同步规则模式

─ 快速交叉模式

─ 慢速交叉模式

─ 交替触发模式

─ 独立模式

还有可以用下列方式组合使用上面的模式：

─ 同步注入模式 + 同步规则模式

─ 同步规则模式 + 交替触发模式

─ 同步注入模式 + 交叉模式

在双ADC模式里，为了在主数据寄存器上读取从转换数据，必须使能DMA位，即使不使用DMA
传输规则通道数据

。。。。。

温度传感器

温度传感器在内部和ADC1_IN16输入通道相连接，此通道把传感器输出的电压转换成数字值。
温度传感器模拟输入推荐采样时间是17.1μs。

当没有被使用时，传感器可以置于关电模式。

必须设置TSVREFE位激活内部通道：ADC1_IN16(温度传感器)和ADC1_IN17(VREFINT)的转换。


![image](https://github.com/user-attachments/assets/d6b80c47-2096-4757-aa92-e48fce971b05)

内部温度传感器更适合于检测温度的变化，而不是测量绝对的温度。如果需要测量精确的温
度，应该使用一个外置的温度传感器。


ADC中断

	规则和注入组转换结束时能产生中断，当模拟看门狗状态位被设置时也能产生中断。它们都有
	独立的中断使能位
	
	ADC1和ADC2的中断映射在同一个中断向量上，而ADC3的中断有自己的中断向量。
	ADC_SR寄存器中有2个其他标志，但是它们没有相关联的中断：
	
	● JSTRT(注入组通道转换的启动) 
	● STRT(规则组通道转换的启动)
	
	
	![image](https://github.com/user-attachments/assets/aa5b324f-3d85-4aa5-9efc-4ea4597d0cd6)

四位逐次逼近ADC实现原理

![image](https://github.com/user-attachments/assets/bb1bc246-cd71-439a-873b-4c0cdfec5ec4)

开关闭合，外部电压对电容充电，

![image](https://github.com/user-attachments/assets/c36ebbce-123a-4005-9076-19ac3e57076f)

电容充满后，断开开关，此时电容电压稳定在外部电压水平，


![image](https://github.com/user-attachments/assets/dd0998c2-4bb0-4abb-82b6-90993ae17ad5)

输入电压范围为0-3.3V，4位ADC，代表2的4次方，共16个状态，每一个单独的状态的电压值为3.3/16约为0.21V
此时输入2.1v，在结果寄存器处，先从最大一位b3开始比较，即1000，经过电压发生器（DAC将数字信号转为模拟电压信号，）用于和比较器的正向输入端作比较。

1000是1.76v,比2.1v小，所以在b2位放1，为1100，为2.64V，大了，所以须将b2位置0，然后置b1为1。。。。，这样依次比较，最终得到1010

推导ADC的采样框图

开关很重要，采样开关

![image](https://github.com/user-attachments/assets/39884142-3eb0-429f-a42a-09c3ab4c3981)

将内部结构替换为框图

![image](https://github.com/user-attachments/assets/af74473c-3ac5-4c93-be71-2ff8f6dbec57)

逐次逼近的12位ADC

![image](https://github.com/user-attachments/assets/4d74973e-fc29-4869-a356-08f804064934)

ADC整体采集流程

![image](https://github.com/user-attachments/assets/23a7a4d4-30cd-4c9c-b558-4cbe6b7d693b)

假设有多路信号需要被ADC通道采集，此时应该怎么办，下面的结果，使用了太多的ADC采集和结果寄存器

![image](https://github.com/user-attachments/assets/18c84e48-bfa5-495c-bec0-faf8a2d73c5d)

采取下面的方式，ADC只有1个，结果寄存器只有1个，但采样开关多个

![image](https://github.com/user-attachments/assets/f7d637ae-3035-4d46-a91a-4fbe47bec107)

使用流程如下，先闭合第一个采样开关，让一路模拟信号对电容充电，充电完成后，断开开关，使用ADC将模拟信号转为12位数字信号，再生成新的信模拟信号，通过比较器
与输入的模拟信号做对比，直到得到逼近后的数字信号结果，存入结果寄存器，读出结果。

![image](https://github.com/user-attachments/assets/e97a0c89-9230-471d-b2a3-a4312e6f9a52)

重复此过程，转换多路信号

![image](https://github.com/user-attachments/assets/d887ff27-06e8-4bd0-8b7d-eb5a74b57bcd)

103的adc信号来源，一部分可以由外部引脚输入，一部分连接到了芯片内部，用于温度计，参考电压的测量

![image](https://github.com/user-attachments/assets/c34765d8-25c8-4d38-8da2-713b5f0d0f09)

cubemx的ADC通道来源

![image](https://github.com/user-attachments/assets/bc2a3b9f-7249-4fda-96ef-fabfd56d8ba6)

通道与IO引脚的对应可以由cubemx点击查看

![image](https://github.com/user-attachments/assets/b810df67-7103-423a-ac65-2ff8ce66af68)

输入源有12路，需要进行管理，分两部分进行管理，分别是外部触发（注入通道）和外部触发（规则通道），通过外部触发信号来启动

![image](https://github.com/user-attachments/assets/701e7737-1eb0-48f1-93e2-d4f98ee04341)

假如打算按照启动IN1、IN2、IN3的计划来启动ADC采集

![image](https://github.com/user-attachments/assets/3e817e26-7bb6-4375-92d6-511ccd9bfb3c)

可以有两种方式进行，一个是常规序列，一个是注入序列

![image](https://github.com/user-attachments/assets/47b17545-0396-4e28-a581-34ce6b1d2c6b)

两个序列的使用方式是一致的，以常规序列为例

![image](https://github.com/user-attachments/assets/2980e614-62ce-44d3-9782-2938ab22b4a9)

只需向外部触发输出一个脉冲信号，便可以按计划执行

![image](https://github.com/user-attachments/assets/a0ba2535-1fd3-4474-bd16-7f34b6cf8ca7)

每次输出脉冲信号都会执行一次ADC采集

![image](https://github.com/user-attachments/assets/25a50cc0-7c1e-4d04-b5b1-7784a56287b2)

举例说明，1ms采集一次外部正弦波信号，在通道5实现，步骤如下：计划表里写执行通道5，然后每1ms发送一次脉冲信号

![image](https://github.com/user-attachments/assets/a6eb36fc-3a01-4bac-a69f-f1585bf6730b)

转换结果如下

![image](https://github.com/user-attachments/assets/2797c96e-2ca0-4e6b-b551-7ab3a7da1346)


采样时间和转换时间

	放重物=采样时间=给电容充电时间，调整砝码时间=转换时间=依次按位输出模拟信号与电容上的模拟信号时间
	
 ![image](https://github.com/user-attachments/assets/941d378f-756b-487f-a6c2-7e629399a2e3)
	
	ADC的时钟，先看STM32的内部框图，
	
![image](https://github.com/user-attachments/assets/f0cc7b17-0b57-4d05-8ad4-b85eaa1e872e)
	
	ADC挂载在APB2总线上
	
![image](https://github.com/user-attachments/assets/a9d82ed3-87f7-4da0-96a8-dcccf41add39)
	
	时钟树分析，APB2产生的PCLK时钟，经过分频最终进入到ADC，而且f103的ADC时钟最大不超过14M，这是由内部电容特性决定
	
![image](https://github.com/user-attachments/assets/5808a9bb-6dbf-40d3-b6b4-411f70f4a783)
	
	介绍时钟的原因，是因为采样时间和转换时间都要表示位时钟频率的倍数。假如ADC时钟频率配置为14MHZ,那么时钟周期就是1/14us
	
![image](https://github.com/user-attachments/assets/82a97e72-a2d0-4431-b3d8-38e4029dd2bb)
	
	假如采样时间0.1us，一般写为时钟周期的倍数，即可近似为1.5*1/14 cycle，即1.5cycle,方便后续编程
	
![image](https://github.com/user-attachments/assets/bb01adbf-fea7-44bf-a326-ef3b23a95808)

转换时间的计算方法

	每次尝试都需要消耗一个时钟周期，12位的要尝试12次，也就是12个时钟周期。
	
![image](https://github.com/user-attachments/assets/ef0f404a-9c80-4289-95d5-31f5e8b83a02)
	
	总共是12+0.5个时钟周期，这个0.5暂时不清楚作用
	
![image](https://github.com/user-attachments/assets/bc4b81c4-474b-400f-a1e7-e01f33b4ae9c)

采样时间计算方法

就是外部模拟信号给电容充电的时间=采样开关闭合的时间
	
![image](https://github.com/user-attachments/assets/7a01ec4e-e3f1-4b32-84fe-56975d86865a)

![image](https://github.com/user-attachments/assets/afef1234-713d-405d-8575-d61b0a1b50a7)

存在误差，采样时越长，误差越小，需要在精度何效率之间做取舍

![image](https://github.com/user-attachments/assets/cf8b801d-7c2b-42ed-bb84-a963c008906a)

ADC是有精度误差的，即分辨率，就是单个最低位代表的电压值，ADC的最大精度误差，需要满足采样误差小于四分之一的ADC分辨率

ADC分辨率就是能够表示出的最小电压值，比如12位ADC，0-3.3v,分辨率就是 0.8mv，四分之一就是0.2mv,

采样误差，是指采集的信号与真实的信号有误差，比如实际信号2.1v=2100mv，

即，2.1v的表示1010，1010转模拟信号与实际信号是有误差的，要满足采集到的信号需要满足误差小于四分之一ADC分辨率

![image](https://github.com/user-attachments/assets/b0acdbc6-214e-4186-8daf-a557be196262)


![image](https://github.com/user-attachments/assets/4070dd91-e2a6-476c-a6a9-d977254a7cbf)

芯片手册关于采样时间的公式

![image](https://github.com/user-attachments/assets/c9f9d60c-bded-4d2a-afca-5af0c56ed55e)

Rin是信号源内阻，当Radc和电容确定以后，采样时间只和信号源的内阻有关，

![image](https://github.com/user-attachments/assets/7cc7746c-5a27-429f-9b3e-e793c767911b)

电阻是电路设计的，电容可以查找手册知道

![image](https://github.com/user-attachments/assets/7efb00a4-8b08-4252-86b2-d83f52cbed34)



采样误差与信号源内阻有关系，怎么能知道信号源的内阻

![image](https://github.com/user-attachments/assets/d2838e37-65cf-4822-ab22-d98916796d62)

以信号源的多种内阻举例

![image](https://github.com/user-attachments/assets/3b837fe9-42e8-4a07-b60a-3eaff0651b22)

要表示为时钟周期，除以14，也就是乘以1/14，即f

![image](https://github.com/user-attachments/assets/18822238-a81a-473d-b708-397f95ac74e4)


单片机中ADC的采样时间是固定的，有固定的挡位，使用时需要从给的挡位中选择。

![image](https://github.com/user-attachments/assets/ce096c78-900c-4c15-b6ae-658a8c3e8439)

![image](https://github.com/user-attachments/assets/db18360a-7df9-4ba5-97a0-f835995e7e98)

根据信号源内阻不同选择采样时间的挡位

![image](https://github.com/user-attachments/assets/3b07963c-a07c-4774-88aa-0be0e265fe0f)

在理想情况下，1秒内ADC可以实现多少次转换

解答，1次转换时间 = 采集时间 + 转换时间，转换时间是固定的，12.5个时钟周期，假设f=14M,理想电源内阻为0欧，

![image](https://github.com/user-attachments/assets/ea7e2526-ebd4-4f7b-86b1-5db06e42bb50)

根据公式可以算算出实际采样时间，约为1个时钟周期，在8个挡位中选取最接近的1.5个时钟周期

![image](https://github.com/user-attachments/assets/2e1f0122-e11b-4c50-b06b-ed1101ae7a4f)

所以，最终的结果就是12.5+1.5=14个时钟周期

![image](https://github.com/user-attachments/assets/fbfbec89-9677-483c-accb-cd70fabfd04a)

总共用时约为一次ADC转换需要1us，

![image](https://github.com/user-attachments/assets/18439d7c-5bf8-4427-b1d1-e94a2f2b07ae)

1秒就是1百万次。

![image](https://github.com/user-attachments/assets/9dcae552-406f-4c15-b394-247d0293319a)



ADC框图对应

![image](https://github.com/user-attachments/assets/f4617793-a86f-467f-b553-a93b6bccaca7)


![image](https://github.com/user-attachments/assets/b1aae711-7636-4463-b8e2-50caf1a5710e)


![image](https://github.com/user-attachments/assets/e24bd803-20e0-4b6e-b45f-b3e6f7f4b56d)




如何计算内阻

电路戴维南定理

如何使用戴维南定理来等效电路

假设目标是对某一负载电阻（或两端口）进行简化分析

步骤 1：断开负载

	从目标电路中断开需要简化的负载电阻（或关注的两端口），保留原电路的其他部分。

步骤 2：计算等效电压 (𝑉𝑡ℎ)
	概念
 
		戴维南等效电压是端口A和B在开路（即负载断开）情况下的电压。
	方法
 
		根据电路分析方法（如节点电压法或回路电流法）计算开路电压。
		确保只考虑原电路中的独立源，忽略负载。


步骤 3：计算等效电阻 (𝑅𝑡ℎ)

	概念
 
		戴维南等效电阻是将电压源短路、电流源开路后，观察从端口A和B之间看到的等效电阻。
	
	方法
	
		短路所有电压源（将电压源替换为导线）。
		开路所有电流源（将电流源替换为开路）。
		使用欧姆定律或电阻组合规则计算端口间的等效电阻。
 
步骤 4：构造戴维南等效电路

	将端口A和B用一个串联电路表示：
 
	等效电压源：𝑉𝑡ℎ
 
	等效电阻：𝑅𝑡ℎ
 
	将负载电阻重新接入简化电路。


示例

问题

假设有以下电路：

一个10 V电压源。

串联一个2 Ω电阻和一个3 Ω电阻。

并联一个4 Ω负载电阻。

求4 Ω负载两端的戴维南等效电路。


![image](https://github.com/user-attachments/assets/69ccf648-3853-4168-8931-4c7effd7484c)


![image](https://github.com/user-attachments/assets/6facd741-c6d3-4d9e-b23d-0162cc8ab060)



假如电阻是变化的，


简单的ADC采集实验

使用二路ADC采集，将得到的值与给定值对比，然后点亮LED

cubemx配置


















		ADC一次注入通道的信号采集能实现什么功能
		
			ADC一次注入通道的信号采集主要用于在特殊情况下的模拟信号采集，其功能和应用场景包括以下几个方面
		 
			 1. 精确采样特定信号
		  
				注入通道可以在规则通道转换过程中中断，并优先完成注入通道的采样。
				功能：
				
					实现对关键信号（如高优先级信号）的实时采样。
					在规则通道采样被占用的情况下，插入采样其他重要信号。
					应用：
					
					实时监测系统的关键参数，例如工业控制中需要监测电流、电压等紧急信号。
		
			2. 支持外部触发的精确定时采样
			注入通道可以通过外部触发信号启动采样，与系统外部事件同步。
			功能：
			
				实现特定时序的信号采样，避免信号采集的时间抖动。
				提高 ADC 数据与系统状态之间的同步性。
				应用：
				
				电机控制：根据 PWM 周期采样电流或位置反馈信号。
		  
				医疗设备：同步采集心电信号等生物电信号。
		   
			3. 灵活的通道切换
			注入通道采样配置与规则通道独立，可以动态选择采样的信号源。
			功能：
			
				在不影响主采样任务的前提下，快速切换采集目标。
				便于调试或采样过程中动态调整采集的信号。
				应用：
				
				自动化测试中动态采集不同的传感器信号。
				电力监测中根据故障诊断结果，临时采集指定信号
		
		  4. 优化系统性能
			通过注入通道采样，可以减少规则通道的中断次数，并避免额外的 CPU 负担。
			功能：
			
				提升规则通道的稳定性和效率。
				确保紧急信号不因规则通道的任务而延迟。
				应用：
				
				飞行控制器等对时间敏感的系统中，采集快速变化的关键信号。
				汽车电子中实时采样关键参数（如油门位置传感器）。
			5. 专用信号优先采集
			注入通道专门用于特定场景的高优先级信号，和规则通道不共享结果寄存器。
			功能：
			
				避免关键数据与普通数据混淆。
				提供专门的结果寄存器，提高数据处理效率。
				应用：
				
				电池管理系统中，实时监测电池的温度、电流等状态。
				多传感器系统中采集高优先级传感器信号（如碰撞检测信号）




 


ADC 简介

STM32f103 系列有 3 个 ADC，精度为 12 位，每个 ADC 最多有 16 个外部通道。其中 ADC1 和
ADC2 都有 16 个外部通道，ADC3 根据 CPU 引脚的不同通道数也不同，一般都有 8 个外部通道。
ADC 的模式非常多











